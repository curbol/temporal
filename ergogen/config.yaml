# Temporal, by Curtis Bollinger - @curbol
# https://github.com/curbol/temporal
# v1 - Jan 2026
#
# Key configurations: 36-42 keys depending on breakoffs and encoders
#   - Full pinky column: 42/41/40 keys (0/1/2 encoders)
#   - Breakoff pinky column: 38/37/36 keys (0/1/2 encoders)
#
# Case naming convention:
#   - _left: Left-hand side case (generated directly)
#   - _m_right: Right-hand side case (needs to be mirrored after ergogen generation)

# ergogen docs: https://docs.ergogen.xyz/config-overview

meta:
  engine: 4.1.0
  version: 1.0
  author: Curtis Bollinger
  url: https://github.com/curbol/temporal

# ============================================================================
# Units
# ============================================================================
units:
  # Math constants
  sqrt_3: 1.73205080757
  nudge: 0.0001 # Hack used to fix floating point rounding issues

  # Override choc defaults
  $default_width: 18
  $default_height: 17

  # Key spacing with padding
  pad: 2.151
  px: cx + pad
  py: cy + pad

  # Key plug holes
  plug_w: 13.9
  plug_h: 13.9

  # Finger splay
  finger_splay_1: 5
  finger_splay_2: 4
  finger_splay_total: finger_splay_1 + finger_splay_2
  thumb_splay: 15
  thumb_spread: 1cx - 0.15

  # Board dimensions
  pcb_fillet: 2.95
  pcb_thickness: 1.6
  top_plate_thickness: 1.3
  pcb_hole_diameter: 5

  # Mounting hole positions (relative to key centers)
  hole1_x: -0.5cx - 0.8 # Top left (finger_middle_top)
  hole1_y: -0.5cy
  hole2_x: 0.5cx - 0.35 # Top right (finger_index_top)
  hole2_y: -0.5cy
  hole3_x: 0.5cx + 1 # Thumb right (thumb_mid)
  hole3_y: -0.5
  hole4_x: 0.5cx + 1 # Thumb left (thumb_enc)
  hole4_y: -0.5
  hole5_x: 0.5cx + 0.6 # Far left (finger_pinky_top)
  hole5_y: -0.5cy
  hole5_e_x: 0.5cx - 0.35 # Far left extra (finger_extra_top)
  hole5_e_y: -0.5cy

  # MCU positioning (relative to finger_inner_home)
  mcu_y: -12.3
  mcu_x: 19.8
  mcu_area_w: 19.45
  mcu_area_h: 56.25
  mcu_pin_spacing: 7.62

  # Display positioning
  display_x: mcu_x
  display_y: 6.75 + mcu_y
  display_w: 11.3
  display_h: 25.8

  # Component positions
  power_x: mcu_x - 0.07
  power_y: 26.1 + mcu_y
  reset_x: 27.4
  reset_y: -14.5 + mcu_y
  battery_x: 24.8
  battery_y: -22 + mcu_y
  battery_rot: -135

  # MCU Cover holes (relative to finger_inner_bottom)
  mcu_hole1_x: 0.5cx + 4
  mcu_hole1_y: -0.5cy + mcu_y + 8
  mcu_hole2_x: 0.5cx + 17.6
  mcu_hole2_y: -0.5cy + mcu_y + 0.146

  # Breakoff tab
  break_cut_w: 0.8
  break_cut_fillet: break_cut_w / 2 - nudge
  break_bridge_size: 3.7

  # Choc
  choc_under_to_pcb: 2.2
  choc_top_plate: 1.3
  choc_pins: 2.65

  # Diode
  diode_y: -3.315
  diode_h: 1.15

  # Case dimensions
  case_expand: 0.1 # Gap between pcb and case walls
  buffer: 0.1
  wall_height: pcb_thickness + choc_under_to_pcb + 0.1 + buffer
  wall_above_pcb: wall_height - pcb_thickness
  wall_thickness: 1.2 + nudge
  side_cut_width: 10.4
  side_cut_radius: (wall_above_pcb + pcb_thickness / 2) / 2
  mcu_catch_radius: 0.68
  bottom_thickness: 1.95
  cutout_fillet: 0.15
  diode_depth: diode_h + buffer
  choc_depth: choc_pins - pcb_thickness + buffer
  pin_depth: 0.5 + buffer

  # M2 hardware
  m2_size: 2
  m2_insert_inner_diameter: 2.7
  m2_insert_outer_diameter: 4.9
  m2_insert_post_height: pcb_thickness + choc_under_to_pcb - choc_top_plate
  m2_insert_hole_depth: 4
  m2_nut_width: 4.2

  # Preview layout offsets
  preview_x: 4px
  preview_y: 3py

# ============================================================================
# Points
# ============================================================================
points:
  zones:
    finger:
      anchor.shift: [50, -100]
      key:
        tags: [key, finger]
        padding: 1cy
        spread: 1cx
      columns:
        extra:
          rows.bottom.skip: true
          key:
            tags: [key, finger, extra]
            splay: finger_splay_total
            column_net: col_extra
        pinky:
          key:
            stagger: 0.52cy
            column_net: col_pinky
        ring:
          key:
            stagger: 0.7cy
            splay: -finger_splay_1
            spread: 1cx + finger_splay_1 / 8
            column_net: col_ring
        middle:
          key:
            stagger: 0.375cy
            splay: -finger_splay_2
            spread: 1cx + finger_splay_2 / 8
            column_net: col_middle
        index:
          key:
            stagger: -0.35cy
            column_net: col_index
        inner:
          key:
            stagger: -0.15cy
            column_net: col_inner
      rows:
        bottom:
          row_net: row_bottom
        home:
          row_net: row_home
        top:
          row_net: row_top

    thumb:
      key:
        tags: [key, thumb]
        padding: 1cy
        spread: 1cx
      anchor:
        ref: finger_index_bottom
        shift: [-0.64cx, -1cy]
      columns:
        enc:
          key:
            splay: 0
            spread: thumb_spread
            origin: [-0.5cx, -0.5cy]
            name: thumb_enc
            column_net: col_ring
        near:
          key: &thumb_splayed
            splay: -thumb_splay
            spread: thumb_spread
            origin: [-0.5cx, -0.5cy]
            name: thumb_near
            column_net: col_middle
        mid:
          key:
            <<: *thumb_splayed
            name: thumb_mid
            column_net: col_index
        far:
          key:
            <<: *thumb_splayed
            name: thumb_far
            column_net: col_inner
      rows:
        thumb:
          row_net: row_thumb

# ============================================================================
# Outlines
# ============================================================================
outlines:
  # MCU and display areas
  _mcu_area:
    - what: rectangle
      where:
        ref: finger_inner_home
        shift: [mcu_x, mcu_y - 5]
      size: [mcu_area_w, mcu_area_h + 10]

  _display:
    - what: rectangle
      where:
        ref: finger_inner_home
        shift: [display_x, display_y]
      size: [display_w, display_h]

  _mcu_cover_holes:
    - what: circle
      radius: m2_size / 2
      where: &mcu_hole1_where
        ref: finger_inner_bottom
        shift: [mcu_hole1_x, mcu_hole1_y]
    - what: circle
      radius: m2_size / 2
      where: &mcu_hole2_where
        ref: finger_inner_bottom
        shift: [mcu_hole2_x, mcu_hole2_y]

  _m2_nut:
    - what: polygon
      adjust.shift: [m2_nut_width / (2 * sqrt_3), m2_nut_width / 2]
      points:
        - shift: [m2_nut_width / (2 * sqrt_3), -m2_nut_width / 2]
        - shift: [-m2_nut_width / (2 * sqrt_3), -m2_nut_width / 2]
        - shift: [-m2_nut_width / sqrt_3, 0]
        - shift: [-m2_nut_width / (2 * sqrt_3), m2_nut_width / 2]
        - shift: [m2_nut_width / (2 * sqrt_3), m2_nut_width / 2]
        - shift: [m2_nut_width / sqrt_3, 0]

  _mcu_cover_nut_cutout:
    - name: _m2_nut
      where: *mcu_hole1_where
    - name: _m2_nut
      where: *mcu_hole2_where

  # Component cutout primitives
  _socket_left_1:
    - what: rectangle # Left block
      size: [4.7, 5.2]
      adjust.shift: [0, 1]
    - what: rectangle # Chamfer
      operation: intersect
      size: [6.1, 6.1]
      adjust: { shift: [0, 1], rotate: 45 }
    - what: rectangle # Left pad
      size: [3.2, 3.2]
      adjust.shift: [-3.3, 1]
    - what: rectangle # Top curve
      size: [0.7, 0.7]
      adjust.shift: [2.35, 1.6]
    - what: circle
      operation: subtract
      radius: 0.35
      adjust.shift: [2.7, 1.95]
    - what: rectangle # Center
      size: [3.2, 3.2]
      adjust.shift: [2.25, 0]
    - what: rectangle # Bottom curve
      size: [2.7, 2.7]
      adjust.shift: [2.15, -1.6]
    - what: circle
      operation: subtract
      radius: 1.35
      adjust.shift: [0.8, -2.95]
    - what: rectangle # Right block
      size: [5.2, 5.4]
      adjust.shift: [4.75, -1.1]
    - what: rectangle # Right pad
      size: [3.2, 3.2]
      adjust.shift: [8.3, -1.2]
      fillet: cutout_fillet
  _socket_left:
    - name: _socket_left_1
      adjust.shift: [0, 4.95]
  _socket_m_right_1:
    - what: rectangle # Right block
      size: [4.7, 5.2]
      adjust.shift: [0, 1]
    - what: rectangle # Chamfer
      operation: intersect
      size: [6.1, 6.1]
      adjust: { shift: [0, 1], rotate: -45 }
    - what: rectangle # Right pad
      size: [3.2, 3.2]
      adjust.shift: [3.3, 1]
    - what: rectangle # Top curve
      size: [0.7, 0.7]
      adjust.shift: [-2.35, 1.6]
    - what: circle
      operation: subtract
      radius: 0.35
      adjust.shift: [-2.7, 1.95]
    - what: rectangle # Center
      size: [3.2, 3.2]
      adjust.shift: [-2.25, 0]
    - what: rectangle # Bottom curve
      size: [2.7, 2.7]
      adjust.shift: [-2.15, -1.6]
    - what: circle
      operation: subtract
      radius: 1.35
      adjust.shift: [-0.8, -2.95]
    - what: rectangle # Left block
      size: [5.2, 5.4]
      adjust.shift: [-4.75, -1.1]
    - what: rectangle # Left pad
      size: [3.2, 3.2]
      adjust.shift: [-8.3, -1.2]
      fillet: cutout_fillet
  _socket_m_right:
    - name: _socket_m_right_1
      adjust.shift: [0, 4.95]

  _solder_pin:
    - what: circle
      radius: 1
      adjust.shift: [-0.25, 0]
    - what: rectangle
      size: [0.5 + nudge*100, 2]
    - what: circle
      radius: 1
      adjust.shift: [0.25, 0]
  _solder_pins_left:
    - name: _solder_pin
      adjust.shift: [-5, -3.8]
    - name: _solder_pin
      adjust.shift: [0, -5.9]
  _solder_pins_m_right:
    - name: _solder_pin
      adjust.shift: [5, -3.8]
    - name: _solder_pin
      adjust.shift: [0, -5.9]

  _diode:
    - what: rectangle
      size: [4.8, 1.8]
      adjust.shift: [0, diode_y]
    - what: rectangle
      size: [3.4, 2.4]
      adjust.shift: [0, diode_y]
      fillet: cutout_fillet

  _choc_side_posts:
    - what: circle
      radius: 1.25
      adjust.shift: [-5.5, 0]
    - what: circle
      radius: 1.25
      adjust.shift: [5.5, 0]
  _choc_post_bridge_left: # Bridge choc post to hotswap socket
    - what: rectangle
      size: [2.5, 2.5]
      adjust.shift: [5.5, 1.25]
  _choc_post_bridge_m_right:
    - what: rectangle
      size: [2.5, 2.5]
      adjust.shift: [-5.5, 1.25]

  _choc_center_post:
    - what: circle
      radius: 2
    - what: rectangle
      size: [2, 2]
      adjust.shift: [0, -2]
  _choc_posts:
    - +_choc_center_post
    - +_choc_side_posts

  _mcu_pins_trench:
    - what: circle
      radius: 1
      adjust.shift: [0, 14]
    - what: rectangle
      size: [2, 28]
    - what: circle
      radius: 1
      adjust.shift: [0, -14]
  _mcu_pins:
    - name: _mcu_pins_trench
      adjust: { shift: [-mcu_pin_spacing, -1.25] }
    - name: _mcu_pins_trench
      adjust: { shift: [mcu_pin_spacing, -1.25], rotate: 180 }

  _mcu_jumpers_trench:
    - what: rectangle
      size: [1.9, 29.55]
      adjust.shift: [2.59, -0.025]
      fillet: cutout_fillet
  _mcu_jumpers:
    - name: _mcu_jumpers_trench
      adjust: { shift: [-mcu_pin_spacing, -1.25] }
    - name: _mcu_jumpers_trench
      adjust: { shift: [mcu_pin_spacing, -1.25], rotate: 180 }

  _display_pins:
    - what: circle
      radius: 1
      adjust.shift: [-5.1, -16.7]
    - what: rectangle
      size: [10.2, 2]
      adjust.shift: [0, -16.7]
    - what: circle
      radius: 1
      adjust.shift: [5.1, -16.7]

  _display_jumpers:
    - what: rectangle
      size: [11.75, 3.8]
      adjust.shift: [0, -15.5]
      fillet: cutout_fillet

  _battery_pins:
    - what: rectangle
      size: [3.6, 2]
      fillet: 0.7

  _battery_jumpers:
    - what: rectangle
      size: [3.6, 3]
      adjust.shift: [0, -1.75]
      fillet: cutout_fillet

  _encoder_pins:
    - what: circle
      radius: 0.75
      adjust.shift: [-2.8, -7.5]
    - what: rectangle
      size: [5.6, 1.5]
      adjust.shift: [0, -7.5]
    - what: circle
      radius: 0.75
      adjust.shift: [2.8, -7.5]
  _encoder_pins_bridge: # Bridge to choc solder hole
    - what: rectangle
      size: [2.5, 2]
      adjust.shift: [0, -6.85]

  # Top-plate cutouts
  _encoder_pins_plate_cutouts:
    - name: _encoder_pins
      where: thumb_enc
      adjust.shift: [0, 0.375]
    - what: rectangle
      size: [7.1, 1.5]
      where:
        ref: thumb_enc
        shift: [0, -6.75 + 0.375]

  # Case bottom cutouts
  _full_depth_38:
    - name: _choc_side_posts
      where: thumb_enc

  _diode_depth:
    - name: _diode
      where: /key/

  _choc_depth_38:
    - name: _choc_posts
      where: [[key, -extra]]
  _choc_depth_pinky:
    - name: _choc_posts
      where: extra

  _pin_depth_38:
    - name: _encoder_pins
      where: thumb_enc
    - name: _mcu_pins
      where: &mcu_pos
        ref: finger_inner_home
        shift: [mcu_x, 10.8 + mcu_y]
    - name: _mcu_jumpers
      where: *mcu_pos
    - name: _display_pins
      where: &display_pos
        ref: finger_inner_home
        shift: [display_x, 7.5 + mcu_y]
    - name: _display_jumpers
      where: *display_pos
    - name: _battery_pins
      where: &battery_pos
        ref: finger_inner_home
        shift: [battery_x, battery_y]
        rotate: battery_rot
    - name: _battery_jumpers
      where: *battery_pos

  _socket_full_depth_38_left:
    - +_full_depth_38
    - name: _choc_post_bridge_left
      where: thumb_enc
    - name: _socket_left
      where: [[key, -extra]]
  _socket_full_depth_38_m_right:
    - +_full_depth_38
    - name: _choc_post_bridge_m_right
      where: thumb_enc
    - name: _socket_m_right
      where: [[key, -extra]]
  _socket_full_depth_pinky_left:
    - name: _socket_left
      where: extra
  _socket_full_depth_pinky_m_right:
    - name: _socket_m_right
      where: extra

  _socket_choc_depth_left:
    - +_choc_depth_38
    - name: _choc_post_bridge_left
      where: [[key, -extra]]
  _socket_choc_depth_m_right:
    - +_choc_depth_38
    - name: _choc_post_bridge_m_right
      where: [[key, -extra]]
  _socket_choc_depth_pinky_left:
    - +_choc_depth_pinky
    - name: _choc_post_bridge_left
      where: extra
  _socket_choc_depth_pinky_m_right:
    - +_choc_depth_pinky
    - name: _choc_post_bridge_m_right
      where: extra

  _solder_pin_depth_38_left:
    - +_pin_depth_38
    - name: _solder_pins_left
      where: [[key, -extra]]
    - name: _encoder_pins_bridge
      where: thumb_enc
  _solder_pin_depth_38_m_right:
    - +_pin_depth_38
    - name: _solder_pins_m_right
      where: [[key, -extra]]
    - name: _encoder_pins_bridge
      where: thumb_enc
  _solder_pin_depth_pinky_left:
    - name: _solder_pins_left
      where: extra
  _solder_pin_depth_pinky_m_right:
    - name: _solder_pins_m_right
      where: extra

  # Case side cutouts
  _case_cutout_left:
    - what: circle
      radius: side_cut_radius
      adjust.shift: [side_cut_radius, -side_cut_radius]
    - what: rectangle
      size: [side_cut_radius * 2, side_cut_radius * 2]
    - what: circle
      radius: side_cut_radius
      adjust.shift: [-side_cut_radius, -side_cut_radius]
      operation: subtract

  _case_cutout_right:
    - what: circle
      radius: side_cut_radius
      adjust.shift: [-side_cut_radius, -side_cut_radius]
    - what: rectangle
      size: [side_cut_radius * 2, side_cut_radius * 2]
    - what: circle
      radius: side_cut_radius
      adjust.shift: [side_cut_radius, -side_cut_radius]
      operation: subtract

  _case_cutout:
    - name: _case_cutout_left
      adjust.shift: [-(side_cut_width / 2), 0]
    - what: rectangle
      size: [side_cut_width - side_cut_radius * 2, side_cut_radius * 4]
    - name: _case_cutout_right
      adjust.shift: [(side_cut_width / 2), 0]

  _case_cutout_half:
    - name: _case_cutout_left
      adjust.shift: [-(side_cut_width / 4), 0]
    - what: rectangle
      size: [(side_cut_width / 2) - side_cut_radius * 2, side_cut_radius * 4]
    - name: _case_cutout_right
      adjust.shift: [(side_cut_width / 4), 0]

  _usbc_case_cutout:
    - name: _case_cutout
      where:
        ref: finger_inner_home
        shift: [mcu_x, mcu_y + mcu_area_h / 2]

  _side_case_cutout:
    - name: _case_cutout_half
      where:
        ref: finger_inner_home
        shift: [mcu_x + mcu_area_w / 2, reset_y]
        rotate: -90

  # MCU Catch
  _mcu_catch_slice:
    - what: circle
      radius: mcu_catch_radius
    - what: rectangle
      operation: subtract
      size: [mcu_catch_radius * 2, mcu_catch_radius * 3]
      adjust.shift: [mcu_catch_radius + wall_thickness / 2, 0]
  _mcu_catch:
    - name: _mcu_catch_slice
      where:
        ref: finger_inner_home
        shift: [mcu_x + mcu_area_w / 2, reset_y]

  # Mounting holes
  _plate_hole:
    - what: circle
      radius: m2_size / 2 + 0.1

  _plate_holes_38:
    - name: _plate_hole
      where: &hole1_pos
        ref: finger_middle_top
        shift: [hole1_x, hole1_y]
    - name: _plate_hole
      where: &hole2_pos
        ref: finger_index_top
        shift: [hole2_x, hole2_y]
    - name: _plate_hole
      where: &hole3_pos
        ref: thumb_mid
        shift: [hole3_x, hole3_y]
    - name: _plate_hole
      where: &hole4_pos
        ref: thumb_enc
        shift: [hole4_x, hole4_y]
    - name: _plate_hole
      where: &hole5_pos
        ref: finger_pinky_top
        shift: [hole5_x, hole5_y]

  _plate_holes_42:
    - +_plate_holes_38
    - name: _plate_hole
      where: &hole5_e_pos
        ref: finger_extra_top
        shift: [hole5_e_x, hole5_e_y]
    - what: circle
      radius: m2_size
      where: *hole5_pos
      operation: subtract

  # M2 insert posts
  _post:
    - what: circle
      radius: m2_insert_outer_diameter / 2

  _post_hole:
    - what: circle
      radius: m2_insert_inner_diameter / 2

  _posts_core:
    - name: _post
      where: *hole1_pos
    - name: _post
      where: *hole2_pos
    - name: _post
      where: *hole3_pos
    - name: _post
      where: *hole4_pos
    - name: _post
      where: *hole5_pos

  _posts_pinky:
    - name: _post
      where: *hole5_pos
    - name: _post
      where: *hole5_e_pos

  _post_holes_core:
    - name: _post_hole
      where: *hole1_pos
    - name: _post_hole
      where: *hole2_pos
    - name: _post_hole
      where: *hole3_pos
    - name: _post_hole
      where: *hole4_pos
    - name: _post_hole
      where: *hole5_pos

  _posts_holes_pinky:
    - name: _post_hole
      where: *hole5_e_pos

  # Thumb cluster smoothing curves
  _thumb_smooth:
    - +_mcu_area
    - name: _mcu_area
      operation: subtract
      adjust.shift: [0, 1.5py]
    - what: rectangle
      where: thumb_far
      size: [px, py]
      fillet: pcb_fillet * 2

  _top_plate_smooth_1:
    - +_thumb_smooth
    - what: rectangle
      where: thumb_mid
      size: [3px, py]
      adjust.shift: [0, py]
      operation: subtract
    - what: rectangle
      where: thumb_mid
      size: [pcb_fillet, pcb_fillet]
      adjust.shift: [1py - 0.6, 0.5py + 0.3]
      operation: subtract
    - what: circle
      where: thumb_mid
      radius: pcb_fillet
      adjust.shift: [1py - pcb_fillet / 2 - 0.6, 0.5py - pcb_fillet]
  _top_plate_smooth:
    - +_thumb_smooth
    - ~_top_plate_smooth_1

  _thumb_arc:
    - what: rectangle
      where: thumb_enc
      size: [4px, py]
    - what: rectangle
      where: thumb_far
      size: [4px, py]
      fillet: 66.62
    - what: rectangle
      where: thumb_mid
      size: [5px, py]
      adjust.shift: [0, 0.5py]
      operation: subtract
    - what: rectangle
      where: thumb_enc
      size: [2px, 2py]
      adjust.shift: [-1.5px, 0]
      operation: subtract
    - what: rectangle
      where: thumb_far
      size: [2px, 2py]
      adjust.shift: [1.5px, 0]
      operation: subtract

  _thumb:
    - what: rectangle
      where: /thumb/
      size: [px, py]
    - +_top_plate_smooth
    - what: polygon
      points:
        - ref: thumb_enc
          shift: [-0.5px, 1.75py]
        - ref: thumb_mid
          shift: [-2px, 0.5py]
        - ref: thumb_mid
          shift: [-0.5px, 0.5py]
        - ref: thumb_mid
          shift: [0.561px, 0.5py]
        - ref: thumb_far
          shift: [0.5px, 0.5py]
        - ref: thumb_far
          shift: [0.5px, 0]
        - ref: thumb_far
          shift: [-0.5px, 0]
        - ref: thumb_mid
          shift: [-0.5px, 0]
        - ref: thumb_near
          shift: [-0.5px, 0]
        - ref: thumb_enc
          shift: [-0.5px, 0]
    - +_thumb_arc
    - what: rectangle
      where: finger_inner_bottom
      size: [px, py]
      adjust.shift: [0, -0.5py]

  _finger_fill:
    - what: rectangle
      where:
        - finger_pinky_top
        - finger_pinky_home
        - finger_ring_top
        - finger_ring_home
        - finger_ring_bottom
        - finger_index_top
      size: [px, py]
      adjust.shift: [1cx, 0]

  # Kickstand outlines
  _kickstand_42_1:
    - what: rectangle
      where: /finger_extra/
      size: [px, py]
      adjust.shift: [-0.5px, 0]
    - what: polygon
      operation: subtract
      points:
        - ref: finger_extra_top
          shift: [-2px, 0.5py]
        - ref: finger_extra_top
          shift: [-0.5px, 0.5py]
        - ref: finger_extra_home
          shift: [0, -2py]
          affect: y
        - ref: finger_extra_home
          shift: [-2px, -2py]
  _kickstand_42_1e:
    - name: _kickstand_42_1
      expand: case_expand + wall_thickness
      joints: 1
  _kickstand_42_1ef:
    - name: _kickstand_42_1e
      fillet: pcb_fillet * 2
  _kickstand_42_2:
    - name: _kickstand_42_1e
    - what: rectangle
      operation: subtract
      where: finger_extra_home
      size: [1px, py]
      adjust.shift: [-0.75px, -0.25px]
    - +_kickstand_42_1ef

  _kickstand_38_1:
    - what: rectangle
      where:
        - finger_pinky_top
        - finger_pinky_home
        - finger_pinky_bottom
      size: [px, py]
      adjust.shift: [-0.5px, 0]
    - what: polygon
      operation: subtract
      points:
        - ref: finger_pinky_top
          shift: [-2px, 0.5py]
        - ref: finger_pinky_top
          shift: [-0.5px, 0.5py]
        - ref: finger_pinky_bottom
          shift: [0, -2py]
          affect: y
        - ref: finger_pinky_bottom
          shift: [-2px, -2py]
  _kickstand_38_1e:
    - name: _kickstand_38_1
      expand: case_expand + wall_thickness
      joints: 1
  _kickstand_38_1ef:
    - name: _kickstand_38_1e
      fillet: pcb_fillet * 2
  _kickstand_38_2:
    - name: _kickstand_38_1e
    - what: rectangle
      operation: subtract
      where: finger_pinky_bottom
      size: [1px, py]
      adjust.shift: [-0.75px, -0.25px]
    - +_kickstand_38_1ef

  # Key areas
  _keys_42:
    - what: rectangle
      where: /key/
      size: [px, py]

  _keys_38:
    - what: rectangle
      where: [[key, -extra]]
      size: [px, py]

  _key_plug:
    - what: rectangle
      size: [plug_w, plug_h]
      fillet: cutout_fillet * 2
  _key_plugs_42:
    - +_encoder_pins_plate_cutouts
    - name: _key_plug
      where: /key/
      fillet: cutout_fillet
  _key_plugs_38:
    - +_encoder_pins_plate_cutouts
    - name: _key_plug
      where: [[key, -extra]]
      fillet: cutout_fillet

  _keys_area_42:
    - +_keys_42
    - +_finger_fill
    - +_thumb

  _keys_area_38:
    - +_keys_38
    - +_finger_fill
    - +_thumb

  # Board outlines
  _board_42:
    - +_mcu_area
    - +_keys_area_42
    - +_thumb_smooth

  _board_38:
    - +_mcu_area
    - +_keys_area_38
    - +_thumb_smooth

  # Breakoff tab for extra pinky
  _break_cut_inner:
    - name: _board_38
      fillet: pcb_fillet

  _break_cut:
    - name: _break_cut_inner
      expand: break_cut_w
      joints: 1
    - -_break_cut_inner

  _break_bridge:
    - what: rectangle
      adjust.shift: [0, 0.25py - 1.06]
      size: [break_cut_w * 2, break_bridge_size]
    - what: rectangle
      adjust.shift: [0, -0.25py + 0.14]
      size: [break_cut_w * 2, break_bridge_size / 2]

  _break_bridges:
    - name: _break_bridge
      where: /finger_extra/
      adjust.shift: [0.5px - pad - break_cut_w / 2, 0]

  _break:
    - +_break_cut
    - -_break_bridges

  # 42-key case outlines
  _case_inner_42_1:
    - name: _board_42
      fillet: pcb_fillet
  _case_inner_42:
    - name: _case_inner_42_1
      expand: case_expand
      joints: 1

  _case_outer_42_1:
    - name: _board_42
      expand: case_expand + wall_thickness
      joints: 1
  _case_outer_42:
    - name: _case_outer_42_1
      fillet: pcb_fillet

  _top_plate_42:
    - name: _keys_area_42
      fillet: pcb_fillet
    - -_key_plugs_42
    - -_plate_holes_42

  _back_plate_42:
    - name: _board_42
      fillet: pcb_fillet
    - -_plate_holes_42

  _kickstand_42:
    - name: _kickstand_42_2
      fillet: pcb_fillet
    - -_case_inner_42

  # 38-key case outlines
  _case_inner_38_1:
    - name: _board_38
      fillet: pcb_fillet
  _case_inner_38:
    - name: _case_inner_38_1
      expand: case_expand
      joints: 1

  _case_outer_38_1:
    - name: _board_38
      expand: case_expand + wall_thickness
      joints: 1
  _case_outer_38:
    - name: _case_outer_38_1
      fillet: pcb_fillet

  _top_plate_38:
    - name: _keys_area_38
      fillet: pcb_fillet
    - -_key_plugs_38
    - -_plate_holes_38

  _back_plate_38:
    - name: _board_38
      fillet: pcb_fillet
    - -_plate_holes_38

  _kickstand_38:
    - name: _kickstand_38_2
      fillet: pcb_fillet
    - -_case_inner_38

  # Common outlines
  _pcb:
    - name: _board_42
      fillet: pcb_fillet
    - name: _break
      fillet: break_cut_fillet
      operation: subtract
    # Uncomment below to debug cutouts:
    # - -_diode_depth
    # - -_pin_depth_38
    # - -_socket_full_depth_38_left
    # - -_socket_full_depth_pinky_left
    # - -_socket_choc_depth_left
    # - -_socket_choc_depth_pinky_left
    # - -_solder_pin_depth_38_left
    # - -_solder_pin_depth_pinky_left
    # Mirrored variants (note: _m_right cases need to be mirrored after ergogen generation):
    # - -_socket_full_depth_38_m_right
    # - -_socket_full_depth_pinky_m_right
    # - -_socket_choc_depth_m_right
    # - -_socket_choc_depth_pinky_m_right
    # - -_solder_pin_depth_38_m_right
    # - -_solder_pin_depth_pinky_m_right
    # Case walls:
    # - -_usbc_case_cutout
    # - -_side_case_cutout
    # - -_mcu_catch

  _mcu_cover:
    - +_mcu_area
    - -_keys_area_42
    - what: rectangle
      where: thumb_mid
      size: [2px, py]
      adjust.shift: [px, 0 + nudge]
      fillet: pcb_fillet
      operation: subtract
    - name: _display
      fillet: cutout_fillet * 2
      operation: subtract
    - -_mcu_cover_holes

  # Preview layouts
  _preview_42:
    - +_case_outer_42
    - -_case_inner_42
    - name: _top_plate_42
      adjust.shift: [-0.01, -0.01]
    - name: _mcu_cover
      adjust.shift: [0.01, 0.01]

  _preview_42_kickstand:
    - +_preview_42
    - +_kickstand_42

  _preview_38:
    - +_case_outer_38
    - -_case_inner_38
    - name: _top_plate_38
      adjust.shift: [-0.01, -0.01]
    - name: _mcu_cover
      adjust.shift: [0.01, 0.01]

  _preview_38_kickstand:
    - +_preview_38
    - +_kickstand_38

  preview:
    - name: _preview_42
      adjust.shift: [-preview_x, preview_y]
    - name: _preview_42_kickstand
      adjust.shift: [-preview_x, -preview_y]
    - name: _preview_38
      adjust.shift: [preview_x, preview_y]
    - name: _preview_38_kickstand
      adjust.shift: [preview_x, -preview_y]

# ============================================================================
# Cases
# ============================================================================
cases:
  mcu_cover:
    - what: outline
      name: _mcu_cover
      extrude: top_plate_thickness

  # Case bottom cutouts - Full depth
  _full_depth_cutouts:
    - what: outline
      name: _mcu_cover_nut_cutout
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]
    - what: outline
      name: _full_depth_38
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]

  _socket_full_depth_cutouts_left:
    - what: outline
      name: _socket_full_depth_38_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]
  _socket_full_depth_cutouts_m_right:
    - what: outline
      name: _socket_full_depth_38_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]
  _socket_full_depth_pinky_cutouts_left:
    - what: outline
      name: _socket_full_depth_pinky_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]
  _socket_full_depth_pinky_cutouts_m_right:
    - what: outline
      name: _socket_full_depth_pinky_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -bottom_thickness * 1.5]

  # Case bottom cutouts - Choc depth
  _choc_depth_cutouts:
    - what: outline
      name: _choc_depth_38
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]
  _choc_depth_pinky_cutouts:
    - what: outline
      name: _choc_depth_pinky
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]

  _socket_choc_depth_cutouts_left:
    - what: outline
      name: _socket_choc_depth_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]
  _socket_choc_depth_cutouts_m_right:
    - what: outline
      name: _socket_choc_depth_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]
  _socket_choc_depth_pinky_cutouts_left:
    - what: outline
      name: _socket_choc_depth_pinky_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]
  _socket_choc_depth_pinky_cutouts_m_right:
    - what: outline
      name: _socket_choc_depth_pinky_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -choc_depth]

  # Case bottom cutouts - Diode depth
  _diode_depth_cutouts:
    - what: outline
      name: _diode_depth
      extrude: bottom_thickness * 2
      shift: [0, 0, -diode_depth]

  # Case bottom cutouts - Pin depth
  _pin_depth_cutouts:
    - what: outline
      name: _pin_depth_38
      extrude: bottom_thickness * 2
      shift: [0, 0, -pin_depth]

  _solder_pin_depth_cutouts_left:
    - what: outline
      name: _solder_pin_depth_38_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -pin_depth]
  _solder_pin_depth_cutouts_m_right:
    - what: outline
      name: _solder_pin_depth_38_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -pin_depth]
  _solder_pin_depth_pinky_cutouts_left:
    - what: outline
      name: _solder_pin_depth_pinky_left
      extrude: bottom_thickness * 2
      shift: [0, 0, -pin_depth]
  _solder_pin_depth_pinky_cutouts_m_right:
    - what: outline
      name: _solder_pin_depth_pinky_m_right
      extrude: bottom_thickness * 2
      shift: [0, 0, -pin_depth]

  _case_outer_42:
    - what: outline
      name: _case_outer_42
      extrude: bottom_thickness + wall_height
      shift: [0, 0, -bottom_thickness]
  _case_outer_38:
    - what: outline
      name: _case_outer_38
      extrude: bottom_thickness + wall_height
      shift: [0, 0, -bottom_thickness]

  _mcu_catch:
    - what: outline
      name: _mcu_catch
      extrude: mcu_area_h
      shift: [0, 0, pcb_thickness + mcu_catch_radius]
      rotate: [-90, 0, 0]
    - ~_case_outer_38

  _wall_cutouts:
    - what: outline
      name: _usbc_case_cutout
      extrude: wall_thickness * 3
      shift: [0, wall_thickness * 2, wall_height]
      rotate: [90, 0, 0]
    - what: outline
      name: _side_case_cutout
      extrude: wall_thickness * 3
      shift: [wall_thickness * 2, 0, wall_height]
      rotate: [0, -90, 0]

  _posts:
    - what: outline
      name: _posts_core
      extrude: m2_insert_post_height
    - what: outline
      name: _post_holes_core
      extrude: m2_insert_hole_depth * 2
      shift: [0, 0, m2_insert_post_height - m2_insert_hole_depth]
      operation: subtract

  _posts_pinky:
    - what: outline
      name: _posts_pinky
      extrude: m2_insert_post_height
    - what: outline
      name: _posts_holes_pinky
      extrude: m2_insert_hole_depth * 2
      shift: [0, 0, m2_insert_post_height - m2_insert_hole_depth]
      operation: subtract

  # 42-key cases
  _temporal_42_1:
    - +_case_outer_42
    - what: outline
      name: _case_inner_42
      extrude: wall_height * 2
      operation: subtract
    - +_mcu_catch
    - -_wall_cutouts
    - -_full_depth_cutouts
    - -_diode_depth_cutouts
    - +_posts
    - +_posts_pinky
  temporal_socket_42_left:
    - +_temporal_42_1
    - -_socket_full_depth_cutouts_left
    - -_socket_full_depth_pinky_cutouts_left
    - -_socket_choc_depth_cutouts_left
    - -_socket_choc_depth_pinky_cutouts_left
    - -_pin_depth_cutouts
  temporal_socket_42_m_right:
    - +_temporal_42_1
    - -_socket_full_depth_cutouts_m_right
    - -_socket_full_depth_pinky_cutouts_m_right
    - -_socket_choc_depth_cutouts_m_right
    - -_socket_choc_depth_pinky_cutouts_m_right
    - -_pin_depth_cutouts
  temporal_solder_42_left:
    - +_temporal_42_1
    - -_choc_depth_cutouts
    - -_choc_depth_pinky_cutouts
    - -_solder_pin_depth_cutouts_left
    - -_solder_pin_depth_pinky_cutouts_left
  temporal_solder_42_m_right:
    - +_temporal_42_1
    - -_choc_depth_cutouts
    - -_choc_depth_pinky_cutouts
    - -_solder_pin_depth_cutouts_m_right
    - -_solder_pin_depth_pinky_cutouts_m_right

  _temporal_42_kickstand_1:
    - what: outline
      name: _kickstand_42
      extrude: bottom_thickness + wall_height
      shift: [0, 0, -bottom_thickness]
  temporal_socket_42_kickstand_left:
    - +_temporal_42_kickstand_1
    - +temporal_socket_42_left
  temporal_socket_42_kickstand_m_right:
    - +_temporal_42_kickstand_1
    - +temporal_socket_42_m_right
  temporal_solder_42_kickstand_left:
    - +_temporal_42_kickstand_1
    - +temporal_solder_42_left
  temporal_solder_42_kickstand_m_right:
    - +_temporal_42_kickstand_1
    - +temporal_solder_42_m_right

  top_plate_42:
    - what: outline
      name: _top_plate_42
      extrude: top_plate_thickness

  # 38-key cases
  _temporal_38_1:
    - +_case_outer_38
    - what: outline
      name: _case_inner_38
      extrude: wall_height * 2
      operation: subtract
    - +_mcu_catch
    - -_wall_cutouts
    - -_full_depth_cutouts
    - -_diode_depth_cutouts
    - +_posts
  temporal_socket_38_left:
    - +_temporal_38_1
    - -_socket_full_depth_cutouts_left
    - -_socket_choc_depth_cutouts_left
    - -_pin_depth_cutouts
  temporal_socket_38_m_right:
    - +_temporal_38_1
    - -_socket_full_depth_cutouts_m_right
    - -_socket_choc_depth_cutouts_m_right
    - -_pin_depth_cutouts
  temporal_solder_38_left:
    - +_temporal_38_1
    - -_choc_depth_cutouts
    - -_solder_pin_depth_cutouts_left
  temporal_solder_38_m_right:
    - +_temporal_38_1
    - -_choc_depth_cutouts
    - -_solder_pin_depth_cutouts_m_right

  _temporal_38_kickstand_1:
    - what: outline
      name: _kickstand_38
      extrude: bottom_thickness + wall_height
      shift: [0, 0, -bottom_thickness]
  temporal_socket_38_kickstand_left:
    - +_temporal_38_kickstand_1
    - +temporal_socket_38_left
  temporal_socket_38_kickstand_m_right:
    - +_temporal_38_kickstand_1
    - +temporal_socket_38_m_right
  temporal_solder_38_kickstand_left:
    - +_temporal_38_kickstand_1
    - +temporal_solder_38_left
  temporal_solder_38_kickstand_m_right:
    - +_temporal_38_kickstand_1
    - +temporal_solder_38_m_right

  top_plate_38:
    - what: outline
      name: _top_plate_38
      extrude: top_plate_thickness

# ============================================================================
# PCBs
# ============================================================================
pcbs:
  temporal:
    template: kicad8
    outlines:
      main:
        outline: _pcb
    footprints:
      choc_hotswap:
        what: ceoloide/switch_choc_v1_v2
        where: /key/
        params:
          from: "{{colrow}}"
          to: "{{column_net}}"
          include_corner_marks: true
          include_keycap: true
          keycap_height: 16.5
          keycap_width: 17.5
          reversible: true
          hotswap: true
          solder: true
          choc_v2_support: false
          trace_width: 0.25
          via_size: 0.6
          via_drill: 0.3
          via_separation: 1.6

      diode:
        what: ceoloide/diode_tht_sod123
        where: /key/
        adjust.shift: [0, diode_y]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
          include_tht: false
          reversible: true
          include_traces_vias: true
          via_size: 0.6
          via_drill: 0.3

      encoder:
        what: ceoloide/rotary_encoder_ec11_ec12
        where: thumb_enc
        params:
          reversible: true
          include_plated_mounting_holes: false
          include_momentary_switch_pads: true
          smd_momentary_switch: true
          A: encoder_a
          C: GND
          B: encoder_b
          S1: col_ring
          S2: enc_thumb

      mcu:
        what: ceoloide/mcu_nice_nano
        where: *mcu_pos
        params:
          reversible: true
          reverse_mount: true
          use_rectangular_jumpers: true
          include_resistor_pads: true
          include_gnd_vias: true
          show_silk_labels: false
          label_font_face: "Maple Mono NF ExtraBold"
          P4: row_top
          P5: row_home
          P6: row_bottom
          P7: row_thumb
          P14: col_inner
          P15: col_index
          P18: col_middle
          P19: col_ring
          P20: col_pinky
          P21: col_extra
          P0: encoder_a
          P1: encoder_b
          P8: MOSI
          P9: SCK
          P10: CS

      display:
        what: ceoloide/display_nice_view
        where: *display_pos
        params:
          reversible: true
          include_labels: false
          include_resistor_pads: true

      power:
        what: ceoloide/power_switch_smd_side
        where:
          ref: finger_inner_home
          shift: [power_x, power_y]
          rotate: 90
        params:
          reversible: true
          include_traces_vias: true
          via_size: 0.6
          via_drill: 0.3

      reset:
        what: ceoloide/reset_switch_smd_side
        where:
          ref: finger_inner_home
          shift: [reset_x, reset_y]
          rotate: -90
        params:
          reversible: true
          include_traces_vias: true
          via_size: 0.6
          via_drill: 0.3

      battery:
        what: ceoloide/battery_connector_jst_ph_2
        where: *battery_pos
        params:
          reversible: true
          include_traces_vias: true
          include_resistor_pads: true
          via_size: 0.6
          via_drill: 0.3

      temporal: &temporal_text
        what: ceoloide/utility_text
        where:
          ref: finger_middle_bottom
          shift: [0, -0.5cy - 2.9]
        params:
          text: "Temporal"
          height: 2
          width: 2
          face: "Maple Mono NF Medium"
          reversible: true

      curbol:
        what: ceoloide/utility_text
        where:
          ref: thumb_far
          shift: [0, -8]
        params:
          text: "curbol"
          height: 1.2
          width: 1.2
          face: "Maple Mono NF ExtraBold"
          reversible: true

      hole_1:
        what: ceoloide/mounting_hole_npth
        where: *hole1_pos
        params: &main_hole_params
          hole_size: pcb_hole_diameter
          hole_drill: pcb_hole_diameter

      hole_2:
        what: ceoloide/mounting_hole_npth
        where: *hole2_pos
        params: *main_hole_params

      hole_3:
        what: ceoloide/mounting_hole_npth
        where: *hole3_pos
        params: *main_hole_params

      hole_4:
        what: ceoloide/mounting_hole_npth
        where: *hole4_pos
        params: *main_hole_params

      hole_5:
        what: ceoloide/mounting_hole_npth
        where: *hole5_pos
        params: *main_hole_params

      hole_5_e:
        what: ceoloide/mounting_hole_npth
        where: *hole5_e_pos
        params: *main_hole_params

      # MCU cover holes
      mcu_hole_L: &mcu_hole_L
        what: ceoloide/mounting_hole_npth
        where: *mcu_hole1_where
        params: &m2_hole_params
          hole_size: m2_size
          hole_drill: m2_size

      mcu_hole_R: &mcu_hole_R
        what: ceoloide/mounting_hole_npth
        where: *mcu_hole2_where
        params: *m2_hole_params

  top_plate_42:
    template: kicad8
    outlines:
      main:
        outline: _top_plate_42
    footprints:
      hole_1: &plate_hole_1
        what: ceoloide/mounting_hole_npth
        where: *hole1_pos
      hole_2: &plate_hole_2
        what: ceoloide/mounting_hole_npth
        where: *hole2_pos
      hole_3: &plate_hole_3
        what: ceoloide/mounting_hole_npth
        where: *hole3_pos
      hole_4: &plate_hole_4
        what: ceoloide/mounting_hole_npth
        where: *hole4_pos
      hole_5_e: &plate_hole_5_e
        what: ceoloide/mounting_hole_npth
        where: *hole5_e_pos
      temporal: *temporal_text

  back_plate_42:
    template: kicad8
    outlines:
      main:
        outline: _back_plate_42
    footprints:
      hole_1: *plate_hole_1
      hole_2: *plate_hole_2
      hole_3: *plate_hole_3
      hole_4: *plate_hole_4
      hole_5_e: *plate_hole_5_e

  top_plate_38:
    template: kicad8
    outlines:
      main:
        outline: _top_plate_38
    footprints:
      hole_1: *plate_hole_1
      hole_2: *plate_hole_2
      hole_3: *plate_hole_3
      hole_4: *plate_hole_4
      hole_5: &plate_hole_5
        what: ceoloide/mounting_hole_npth
        where: *hole5_pos
      temporal: *temporal_text

  back_plate_38:
    template: kicad8
    outlines:
      main:
        outline: _back_plate_38
    footprints:
      hole_1: *plate_hole_1
      hole_2: *plate_hole_2
      hole_3: *plate_hole_3
      hole_4: *plate_hole_4
      hole_5: *plate_hole_5

  mcu_cover:
    template: kicad8
    outlines:
      main:
        outline: _mcu_cover
    footprints:
      mcu_hole_L: *mcu_hole_L
      mcu_hole_R: *mcu_hole_R
